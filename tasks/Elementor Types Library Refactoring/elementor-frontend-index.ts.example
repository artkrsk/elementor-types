/**
 * Elementor Frontend Types
 * Types and interfaces for Elementor frontend functionality
 */

import type { JQuery } from 'jquery';
import type { Swiper, SwiperOptions } from 'swiper/types';
import type { ViewModule } from '../core';

// ============================================================================
// Main Frontend Interface
// ============================================================================

/**
 * Main Elementor Frontend instance
 */
export interface ElementorFrontend {
  config: ElementorFrontendConfig;
  elements: FrontendElements;
  breakpoints: ElementorBreakpoints;
  utils: FrontendUtils;
  hooks: ElementorHooks;
  elementsHandler: ElementsHandler;
  documentsManager: DocumentsManager;

  // Methods
  init(): void;
  isEditMode(): boolean;
  isWPPreviewMode(): boolean;
  getCurrentDeviceMode(): string;
  getCurrentDeviceSetting(settings: object, settingKey: string): any;
  getDeviceSetting(
    deviceMode: string,
    settings: object,
    settingKey: string
  ): any;
  getKitSettings(settingName?: string): any;
  getPageSettings(settingName?: string): any;
  getGeneralSettings(settingName?: string): any;
  
  // Event listeners
  addListenerOnce(
    listenerID: string,
    event: string,
    callback: Function,
    to?: any
  ): void;
  removeListeners(
    listenerID: string,
    event: string,
    callback?: Function,
    from?: any
  ): void;
  
  // Utilities
  debounce(func: Function, wait: number): Function;
  
  // Event emitter
  on(eventName: string, callback: Function): void;
  off(eventName: string, callback?: Function): void;
  trigger(eventName: string, ...args: any[]): void;
}

// ============================================================================
// Configuration
// ============================================================================

/**
 * Frontend configuration object
 */
export interface ElementorFrontendConfig {
  environmentMode: EnvironmentMode;
  is_rtl: boolean;
  breakpoints: BreakpointValues;
  responsive: ResponsiveConfig;
  version: string;
  is_static: boolean;
  legacyMode: LegacyMode;
  urls: FrontendUrls;
  settings: FrontendSettings;
  kit: KitSettings;
  elements: ElementsData;
  i18n: I18nStrings;
  experimentalFeatures: ExperimentalFeatures;
}

export interface EnvironmentMode {
  edit: boolean;
  wpPreview: boolean;
  isScriptDebug: boolean;
}

export interface BreakpointValues {
  xs: number;
  sm: number;
  md: number;
  lg: number;
  xl: number;
  xxl: number;
}

export interface ResponsiveConfig {
  breakpoints: Record<string, BreakpointConfig>;
  activeBreakpoints: Record<string, BreakpointConfig>;
  hasCustomBreakpoints?: boolean;
}

export interface BreakpointConfig {
  label: string;
  value: number;
  default_value: number;
  direction: 'min' | 'max';
  is_enabled: boolean;
}

export interface LegacyMode {
  elementWrappers: boolean;
}

export interface FrontendUrls {
  assets: string;
  rest: string;
  uploadUrl: string;
}

export interface FrontendSettings {
  page: Record<string, any>;
  editorPreferences?: Record<string, any>;
}

export interface KitSettings {
  [key: string]: any;
}

export interface ElementsData {
  data: Record<string, ElementData>;
}

export interface ElementData {
  id: string;
  elType: string;
  widgetType?: string;
  settings: object;
  attributes: Record<string, any>;
}

export interface I18nStrings {
  [key: string]: string;
  a11yCarouselPrevSlideMessage?: string;
  a11yCarouselNextSlideMessage?: string;
  a11yCarouselFirstSlideMessage?: string;
  a11yCarouselLastSlideMessage?: string;
}

export interface ExperimentalFeatures {
  e_font_icon_svg?: boolean;
  container?: boolean;
  'nested-elements'?: boolean;
  [key: string]: boolean | undefined;
}

// ============================================================================
// Frontend Elements
// ============================================================================

export interface FrontendElements {
  window: Window;
  $window: JQuery<Window>;
  $document: JQuery<Document>;
  $head: JQuery<HTMLHeadElement>;
  $body: JQuery<HTMLBodyElement>;
  $deviceMode: JQuery;
  $wpAdminBar?: JQuery;
}

// ============================================================================
// Utils
// ============================================================================

export interface FrontendUtils {
  lightbox: Promise<any>;
  swiper: typeof Swiper;
  assetsLoader: AssetsLoader;
  controls: Controls;
  vimeo: VideoLoader;
  youtube: VideoLoader;
  anchors: any;
  events: Events;
  urlActions: UrlActions;
}

export interface AssetsLoader {
  load(type: 'script' | 'style', key: string): Promise<boolean>;
  getScriptElement(src: string): HTMLScriptElement;
  getStyleElement(src: string): HTMLLinkElement;
  loadAsset(assetData: any, assetType: string): Promise<boolean>;
  isAssetLoaded(assetData: any, assetType: string): boolean;
  appendAsset(assetData: any, element: HTMLElement): void;
}

export interface Controls {
  getControlValue(
    controlSettings: object,
    controlKey: string,
    controlSubKey?: string
  ): any;
  getResponsiveControlValue(
    controlSettings: object,
    controlKey: string,
    controlSubKey?: string,
    device?: string | null
  ): any;
}

export interface VideoLoader {
  getApiURL(): string;
  getURLRegex(): RegExp;
  isApiLoaded(): boolean;
  getApiObject(): any;
  getVideoIDFromURL(url: string): string | null;
  onApiReady(callback: Function): void;
  getAutoplayURL(videoURL: string): string;
}

export interface Events {
  dispatch(
    context: HTMLElement | JQuery,
    event: string,
    data?: any,
    bcEvent?: string | null
  ): void;
}

export interface UrlActions extends ViewModule {
  actions: Record<string, (settings: any, ...args: any[]) => void>;
  addAction(name: string, callback: Function): void;
  runAction(url: string, ...restArgs: any[]): void;
  runLinkAction(event: Event): void;
  runHashAction(): void;
  createActionHash(action: string, settings: object): string;
}

// ============================================================================
// Hooks System
// ============================================================================

export interface ElementorHooks {
  addAction(
    action: string,
    callback: Function,
    priority?: number,
    context?: any
  ): void;
  doAction(action: string, ...args: any[]): void;
  removeAction(action: string, callback?: Function): void;
  addFilter(
    filter: string,
    callback: Function,
    priority?: number,
    context?: any
  ): void;
  applyFilters(filter: string, value: any, ...args: any[]): any;
}

// ============================================================================
// Elements Handler
// ============================================================================

export interface ElementsHandler {
  addHandler(
    HandlerClass: HandlerConstructor,
    options: HandlerOptions
  ): void;
  attachHandler(elementName: string, Handlers: any, skin?: string): void;
  getHandler(handlerName: string): Promise<HandlerConstructor>;
  getHandlers(handlerName?: string): any;
  runReadyTrigger(scope: HTMLElement | JQuery): void;
  init(): void;
  elementsHandlers: Record<string, any>;
}

export interface HandlerOptions {
  $element: JQuery;
  elementName?: string;
  model?: any;
}

export type HandlerConstructor = new (options: HandlerOptions) => BaseHandler;

// ============================================================================
// Documents Manager
// ============================================================================

export interface DocumentsManager extends ViewModule {
  documents: Record<string, FrontendDocument>;
  documentClasses: Record<string, typeof FrontendDocument>;
  initDocumentClasses(): void;
  addDocumentClass(
    documentType: string,
    documentClass: typeof FrontendDocument
  ): void;
  attachDocumentsClasses(): void;
  attachDocumentClass($document: JQuery): void;
}

export interface FrontendDocument extends ViewModule {
  $element: JQuery;
  isEdit: boolean;
  getDocumentSettings(setting?: string): any;
  runElementsHandlers(): void;
  onSettingsChange(): void;
}

// ============================================================================
// Breakpoints
// ============================================================================

export interface ElementorBreakpoints {
  responsiveConfig: ResponsiveConfig;
  getActiveBreakpointsList(args?: {
    largeToSmall?: boolean;
    withDesktop?: boolean;
  }): string[];
  getBreakpointValues(): number[];
  getDesktopPreviousDeviceKey(): string;
  getDesktopMinPoint(): number;
  getDeviceMinBreakpoint(device: string): number;
  getActiveMatchRegex(): RegExp;
}

// ============================================================================
// Re-export handler types from their module
// ============================================================================
export * from './handlers';

// ============================================================================
// Type Guards
// ============================================================================

/**
 * Check if object is ElementorFrontend instance
 */
export function isElementorFrontend(obj: any): obj is ElementorFrontend {
  return obj && 
         typeof obj.isEditMode === 'function' &&
         typeof obj.init === 'function' &&
         obj.config !== undefined;
}

/**
 * Check if running in frontend context
 */
export function isFrontendReady(): boolean {
  return typeof window !== 'undefined' && 
         window.elementorFrontend !== undefined &&
         window.elementorFrontend.config !== undefined;
}